import{u as be,s as V}from"./index-BHoJcF0t.js";import{p as ke,E as y,b as Ve}from"./elementPlus-BZK7s8Hm.js";import{v as Ce,c as xe,r as C,l as M,j as Ie,B as w,C as l,D as a,ak as i,y as f,K as x,P as q,a4 as L,M as u,E as j,J as we,aq as Ue,O as B,u as he,z as d}from"./vue-Oyw5Wt-7.js";import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ze={class:"page-container"},Ne={class:"toolbar"},De={key:1},$e={key:0},Be=Ce({__name:"index",setup(Ee){const J=be(),S=xe(()=>J.isAdmin),z=s=>J.hasPermission(s),O=C(!1),U=C(!1),T=C([]),A=C([]),p=M({name:"",status:void 0,hotelId:void 0}),k=M({page:1,size:10,total:0}),h=C(!1),H=C(),o=M({id:void 0,name:"",category:"",price:0,stock:0,images:[],description:"",status:1,hotelIds:[]}),Q=["食品","护理","玩具","清洁","医疗","其他"],N=C([]),X={name:[{required:!0,message:"请输入商品名称",trigger:"blur"}],price:[{required:!0,message:"请输入单价",trigger:"blur"}],stock:[{required:!0,message:"请输入库存",trigger:"blur"}],hotelIds:[{required:S.value,message:"请选择门店",trigger:"change"}]},D=C(!1),m=M({id:0,name:"",delta:0}),Y=async()=>{if(!S.value)return;const s=await V.get("/hotel/list");A.value=s.data||[]},_=async()=>{O.value=!0;try{const s=await V.get("/product/page",{params:{pageNum:k.page,pageSize:k.size,name:p.name||void 0,status:p.status,hotelId:p.hotelId}});T.value=s.data.records||[],k.total=s.data.total||0}finally{O.value=!1}},Z=()=>{p.name="",p.status=void 0,p.hotelId=void 0,_()},ee=()=>{P(),h.value=!0},te=s=>{P(),o.id=s.id,o.name=s.name,o.category=s.category,o.price=s.price,o.stock=s.stock,o.description=s.description||"",o.status=s.status,o.hotelIds=s.hotelIds?[...s.hotelIds]:[];const e=E(s.images||"");o.images=e,N.value=e.map((c,n)=>({name:`image-${n}`,url:c,uid:Date.now()+n})),h.value=!0},P=()=>{o.id=void 0,o.name="",o.category="",o.price=0,o.stock=0,o.images=[],o.description="",o.status=1,o.hotelIds=[],N.value=[]},le=async()=>{var s;await((s=H.value)==null?void 0:s.validate()),U.value=!0;try{const e={...o};S.value||(e.hotelIds=void 0),e.images=o.images.length?JSON.stringify(o.images):"",o.id?(await V.put("/product",e),y.success("更新成功")):(await V.post("/product",e),y.success("新增成功")),h.value=!1,_()}catch(e){y.error((e==null?void 0:e.message)||"操作失败")}finally{U.value=!1}},ae=async s=>{const e=s.status===1?0:1;await V.put(`/product/${s.id}/status`,{status:e}),y.success("状态已更新"),_()},oe=s=>{m.id=s.id,m.name=s.name,m.delta=0,D.value=!0},se=()=>{m.id=0,m.name="",m.delta=0},ne=async()=>{if(m.id){U.value=!0;try{await V.put(`/product/${m.id}/stock`,{delta:m.delta}),y.success("库存已调整"),D.value=!1,_()}finally{U.value=!1}}},de=async s=>{await Ve.confirm("确认删除该商品吗？","提示",{type:"warning"}),await V.delete(`/product/${s.id}`),y.success("删除成功"),_()},E=s=>{if(!s)return[];try{return JSON.parse(s)}catch{return[]}},ie=s=>{const e=s.type.startsWith("image/"),c=s.size/1024/1024<10;return e?c?!0:(y.error("图片大小不能超过10MB"),!1):(y.error("只能上传图片文件"),!1)},ue=async s=>{const{file:e,onSuccess:c,onError:n}=s;try{const g=new FormData;g.append("file",e);const b=await V.post("/upload/single",g,{headers:{"Content-Type":"multipart/form-data"}}),r={url:b.data.url,fileName:b.data.fileName};c(r);const I=N.value.find(F=>F.uid===e.uid);I&&(I.url=b.data.url,I.response=r),o.images.push(b.data.url),y.success("图片上传成功")}catch(g){n(g),y.error("图片上传失败")}},re=s=>{var n;const e=((n=s.response)==null?void 0:n.url)||s.url,c=o.images.indexOf(e);c>-1&&o.images.splice(c,1)};return Ie(()=>{Y(),_()}),(s,e)=>{const c=i("el-input"),n=i("el-form-item"),g=i("el-option"),b=i("el-select"),r=i("el-button"),I=i("el-form"),F=i("el-card"),v=i("el-table-column"),pe=i("el-image"),K=i("el-tag"),me=i("el-table"),ce=i("el-pagination"),R=i("el-input-number"),fe=i("el-icon"),ge=i("el-upload"),W=i("el-radio"),ve=i("el-radio-group"),G=i("el-dialog"),ye=Ue("loading");return d(),w("div",ze,[l(F,{shadow:"never",class:"search-form"},{default:a(()=>[l(I,{inline:!0,model:p},{default:a(()=>[l(n,{label:"商品名称"},{default:a(()=>[l(c,{modelValue:p.name,"onUpdate:modelValue":e[0]||(e[0]=t=>p.name=t),placeholder:"请输入商品名称",clearable:""},null,8,["modelValue"])]),_:1}),l(n,{label:"状态"},{default:a(()=>[l(b,{modelValue:p.status,"onUpdate:modelValue":e[1]||(e[1]=t=>p.status=t),placeholder:"全部状态",clearable:""},{default:a(()=>[l(g,{label:"上架",value:1}),l(g,{label:"下架",value:0})]),_:1},8,["modelValue"])]),_:1}),S.value?(d(),f(n,{key:0,label:"门店"},{default:a(()=>[l(b,{modelValue:p.hotelId,"onUpdate:modelValue":e[2]||(e[2]=t=>p.hotelId=t),placeholder:"全部门店",clearable:"",style:{width:"200px"}},{default:a(()=>[(d(!0),w(q,null,L(A.value,t=>(d(),f(g,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):x("",!0),l(n,null,{default:a(()=>[l(r,{type:"primary",onClick:_},{default:a(()=>[...e[18]||(e[18]=[u("搜索",-1)])]),_:1}),l(r,{onClick:Z},{default:a(()=>[...e[19]||(e[19]=[u("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(F,{shadow:"never"},{default:a(()=>[j("div",Ne,[z("product:add")?(d(),f(r,{key:0,type:"primary",onClick:ee},{default:a(()=>[...e[20]||(e[20]=[u(" 新增商品 ",-1)])]),_:1})):x("",!0)]),we((d(),f(me,{data:T.value,stripe:"",border:""},{default:a(()=>[l(v,{prop:"id",label:"ID",width:"80"}),l(v,{label:"图片",width:"90"},{default:a(({row:t})=>[E(t.images).length?(d(),f(pe,{key:0,src:E(t.images)[0],"preview-src-list":E(t.images),fit:"cover",style:{width:"40px",height:"40px","border-radius":"4px"}},null,8,["src","preview-src-list"])):(d(),w("span",De,"-"))]),_:1}),l(v,{prop:"name",label:"商品名称","min-width":"160"}),l(v,{prop:"category",label:"分类",width:"120"}),l(v,{prop:"price",label:"单价",width:"100"},{default:a(({row:t})=>[u(" ¥"+B(t.price),1)]),_:1}),l(v,{prop:"stock",label:"库存",width:"90"}),l(v,{prop:"hotelNames",label:"关联门店","min-width":"180"},{default:a(({row:t})=>[(d(!0),w(q,null,L(t.hotelNames||[],($,_e)=>(d(),f(K,{key:_e,class:"mr-1",type:"info"},{default:a(()=>[u(B($),1)]),_:2},1024))),128)),!t.hotelNames||t.hotelNames.length===0?(d(),w("span",$e,"-")):x("",!0)]),_:1}),l(v,{prop:"status",label:"状态",width:"100"},{default:a(({row:t})=>[l(K,{type:t.status===1?"success":"info"},{default:a(()=>[u(B(t.status===1?"上架":"下架"),1)]),_:2},1032,["type"])]),_:1}),l(v,{prop:"createdAt",label:"创建时间",width:"180"}),l(v,{label:"操作",width:"240",fixed:"right"},{default:a(({row:t})=>[z("product:edit")?(d(),f(r,{key:0,type:"primary",link:"",onClick:$=>te(t)},{default:a(()=>[...e[21]||(e[21]=[u("编辑",-1)])]),_:1},8,["onClick"])):x("",!0),z("product:status")?(d(),f(r,{key:1,type:"warning",link:"",onClick:$=>ae(t)},{default:a(()=>[u(B(t.status===1?"下架":"上架"),1)]),_:2},1032,["onClick"])):x("",!0),z("product:stock")?(d(),f(r,{key:2,type:"info",link:"",onClick:$=>oe(t)},{default:a(()=>[...e[22]||(e[22]=[u("库存",-1)])]),_:1},8,["onClick"])):x("",!0),z("product:delete")?(d(),f(r,{key:3,type:"danger",link:"",onClick:$=>de(t)},{default:a(()=>[...e[23]||(e[23]=[u("删除",-1)])]),_:1},8,["onClick"])):x("",!0)]),_:1})]),_:1},8,["data"])),[[ye,O.value]]),l(ce,{class:"pagination","current-page":k.page,"onUpdate:currentPage":e[3]||(e[3]=t=>k.page=t),"page-size":k.size,"onUpdate:pageSize":e[4]||(e[4]=t=>k.size=t),"page-sizes":[10,20,50,100],total:k.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_,onCurrentChange:_},null,8,["current-page","page-size","total"])]),_:1}),l(G,{modelValue:h.value,"onUpdate:modelValue":e[14]||(e[14]=t=>h.value=t),title:o.id?"编辑商品":"新增商品",width:"600px",onClose:P},{footer:a(()=>[l(r,{onClick:e[13]||(e[13]=t=>h.value=!1)},{default:a(()=>[...e[27]||(e[27]=[u("取消",-1)])]),_:1}),l(r,{type:"primary",loading:U.value,onClick:le},{default:a(()=>[...e[28]||(e[28]=[u("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(I,{model:o,rules:X,ref_key:"formRef",ref:H,"label-width":"100px"},{default:a(()=>[l(n,{label:"商品名称",prop:"name"},{default:a(()=>[l(c,{modelValue:o.name,"onUpdate:modelValue":e[5]||(e[5]=t=>o.name=t),placeholder:"请输入商品名称"},null,8,["modelValue"])]),_:1}),l(n,{label:"分类",prop:"category"},{default:a(()=>[l(b,{modelValue:o.category,"onUpdate:modelValue":e[6]||(e[6]=t=>o.category=t),filterable:"","allow-create":"","default-first-option":"",placeholder:"如：食品/护理/玩具",style:{width:"100%"}},{default:a(()=>[(d(),w(q,null,L(Q,t=>l(g,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"单价",prop:"price"},{default:a(()=>[l(R,{modelValue:o.price,"onUpdate:modelValue":e[7]||(e[7]=t=>o.price=t),min:0,precision:2,step:1},null,8,["modelValue"])]),_:1}),l(n,{label:"库存",prop:"stock"},{default:a(()=>[l(R,{modelValue:o.stock,"onUpdate:modelValue":e[8]||(e[8]=t=>o.stock=t),min:0,step:1},null,8,["modelValue"])]),_:1}),l(n,{label:"商品图片"},{default:a(()=>[l(ge,{"file-list":N.value,"onUpdate:fileList":e[9]||(e[9]=t=>N.value=t),action:"#","http-request":ue,"on-remove":re,"before-upload":ie,"list-type":"picture-card",limit:8,accept:"image/*"},{default:a(()=>[l(fe,null,{default:a(()=>[l(he(ke))]),_:1})]),_:1},8,["file-list"]),e[24]||(e[24]=j("div",{style:{color:"#999","font-size":"12px","margin-top":"8px"}}," 最多上传8张图片，支持jpg/png，单张不超过10MB ",-1))]),_:1}),S.value?(d(),f(n,{key:0,label:"门店",prop:"hotelIds"},{default:a(()=>[l(b,{modelValue:o.hotelIds,"onUpdate:modelValue":e[10]||(e[10]=t=>o.hotelIds=t),multiple:"",placeholder:"请选择门店",style:{width:"100%"}},{default:a(()=>[(d(!0),w(q,null,L(A.value,t=>(d(),f(g,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):x("",!0),l(n,{label:"状态",prop:"status"},{default:a(()=>[l(ve,{modelValue:o.status,"onUpdate:modelValue":e[11]||(e[11]=t=>o.status=t)},{default:a(()=>[l(W,{label:1},{default:a(()=>[...e[25]||(e[25]=[u("上架",-1)])]),_:1}),l(W,{label:0},{default:a(()=>[...e[26]||(e[26]=[u("下架",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"描述",prop:"description"},{default:a(()=>[l(c,{modelValue:o.description,"onUpdate:modelValue":e[12]||(e[12]=t=>o.description=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(G,{modelValue:D.value,"onUpdate:modelValue":e[17]||(e[17]=t=>D.value=t),title:"库存调整",width:"420px",onClose:se},{footer:a(()=>[l(r,{onClick:e[16]||(e[16]=t=>D.value=!1)},{default:a(()=>[...e[29]||(e[29]=[u("取消",-1)])]),_:1}),l(r,{type:"primary",loading:U.value,onClick:ne},{default:a(()=>[...e[30]||(e[30]=[u("确认",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(I,{model:m,"label-width":"100px"},{default:a(()=>[l(n,{label:"商品"},{default:a(()=>[j("span",null,B(m.name),1)]),_:1}),l(n,{label:"调整数量"},{default:a(()=>[l(R,{modelValue:m.delta,"onUpdate:modelValue":e[15]||(e[15]=t=>m.delta=t),min:-99999,max:99999},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Oe=Se(Be,[["__scopeId","data-v-c0850720"]]);export{Oe as default};
