import{u as _e,s as N}from"./index-BHoJcF0t.js";import{E as V,b as ye}from"./elementPlus-BZK7s8Hm.js";import{v as be,r as m,l as $,c as Ne,j as Ve,B as U,C as l,D as o,ak as s,M as g,E as L,J as he,aq as we,y as D,O as Te,P as Y,a4 as G,z as y}from"./vue-Oyw5Wt-7.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ce={class:"page-container"},Ie={class:"table-toolbar"},xe={key:1},ze={class:"image-list"},Ue=be({__name:"index",setup(De){const A=m(!1),E=m(!1),C=m(!1),P=m([]),h=m([]),w=m(!1),B=m(!1),S=m([]),x=m(),v=_e(),T=m([]),u=$({orderNo:"",petName:"",careType:null}),f=$({page:1,size:10,total:0}),r=$({id:null,orderId:null,careType:null,content:"",images:""}),J=Ne(()=>r.id?"编辑照料记录":"添加照料记录"),W={orderId:[{required:!0,message:"请选择订单",trigger:"change"}],careType:[{required:!0,message:"请选择日志类型",trigger:"change"}],content:[{required:!0,message:"请输入照料内容",trigger:"blur"}]},H={1:"喂食",2:"遛弯",3:"清洁",4:"体检",5:"其他",6:"入住登记"},K={1:"success",2:"warning",3:"primary",4:"danger",5:"info",6:"info"},Q=a=>H[a]||String(a??""),X=a=>K[a]||"",k=async()=>{A.value=!0;try{const a=await N.get("/care-log/page",{params:{page:f.page,size:f.size,orderNo:u.orderNo||void 0,petName:u.petName||void 0,careType:u.careType??void 0}});P.value=a.data.records,f.total=a.data.total}catch(a){console.error("获取照料日志失败:",a)}finally{A.value=!1}},Z=async a=>{if(!a){v.isAdmin||await M();return}C.value=!0;try{const e=await N.get("/order/page",{params:{page:1,size:20,orderNo:a,hotelId:v.isAdmin?void 0:v.hotelId??void 0,status:2,petName:void 0}});h.value=e.data.records}catch(e){console.error("搜索订单失败:",e)}finally{C.value=!1}},M=async()=>{if(!v.isAdmin&&v.hotelId){C.value=!0;try{const a=await N.get("/order/page",{params:{page:1,size:50,hotelId:v.hotelId,status:2}});h.value=a.data.records}catch(a){console.error("加载入住订单失败:",a)}finally{C.value=!1}}},ee=async a=>{a&&(v.isAdmin||h.value.length>0||await M())},R=()=>{f.page=1,k()},le=()=>{u.orderNo="",u.petName="",u.careType=null,R()},ae=()=>{de(),v.isAdmin||M(),w.value=!0},te=a=>{Object.assign(r,{id:a.id,orderId:a.orderId,careType:a.careType,content:a.content,images:a.images}),h.value=[{id:a.orderId,orderNo:a.orderNo,roomNo:a.roomNo,petNames:a.petName}];const e=(a.images||"").split(",").map(d=>d.trim()).filter(Boolean);T.value=e.map((d,i)=>({name:`image-${i}`,url:d,uid:Date.now()+i})),w.value=!0},oe=a=>{S.value=(a.images||"").split(",").map(e=>e.trim()).filter(Boolean),B.value=!0},re=a=>{const e=a.type.startsWith("image/"),d=a.size/1024/1024<10;return e?d?!0:(V.error("图片大小不能超过10MB"),!1):(V.error("只能上传图片文件"),!1)},ne=async a=>{const{file:e,onSuccess:d,onError:i}=a;try{const n=new FormData;n.append("file",e);const b=await N.post("/upload/single",n,{headers:{"Content-Type":"multipart/form-data"}}),z={url:b.data.url,fileName:b.data.fileName};d(z);const _=T.value.find(p=>p.uid===e.uid);_&&(_.url=b.data.url,_.response=z),V.success("图片上传成功")}catch(n){i(n),V.error("图片上传失败")}},se=async a=>{try{await ye.confirm("确定要删除该照料记录吗？","提示",{type:"warning"}),await N.delete(`/care-log/${a.id}`),V.success("删除成功"),k()}catch(e){e!=="cancel"&&console.error("删除失败:",e)}},ie=async()=>{if(x.value)try{await x.value.validate(),E.value=!0;const a=T.value.map(d=>{var i;return((i=d.response)==null?void 0:i.url)||d.url}).filter(Boolean),e={orderId:r.orderId,careType:r.careType,content:r.content,images:a.join(",")};r.id?(await N.put(`/care-log/${r.id}`,e),V.success("更新成功")):(await N.post("/care-log",e),V.success("创建成功")),w.value=!1,k()}catch(a){console.error("提交失败:",a)}finally{E.value=!1}},de=()=>{var a;r.id=null,r.orderId=null,r.careType=null,r.content="",r.images="",h.value=[],T.value=[],(a=x.value)==null||a.clearValidate()};return Ve(()=>{k()}),(a,e)=>{const d=s("el-input"),i=s("el-form-item"),n=s("el-option"),b=s("el-select"),z=s("Search"),_=s("el-icon"),p=s("el-button"),ue=s("Refresh"),F=s("el-form"),j=s("el-card"),O=s("Plus"),c=s("el-table-column"),pe=s("el-tag"),ce=s("el-table"),me=s("el-pagination"),fe=s("el-upload"),q=s("el-dialog"),ge=s("el-image"),ve=we("loading");return y(),U("div",Ce,[l(j,{shadow:"never",class:"search-form"},{default:o(()=>[l(F,{inline:!0,model:u},{default:o(()=>[l(i,{label:"订单号"},{default:o(()=>[l(d,{modelValue:u.orderNo,"onUpdate:modelValue":e[0]||(e[0]=t=>u.orderNo=t),placeholder:"请输入订单号",clearable:""},null,8,["modelValue"])]),_:1}),l(i,{label:"宠物名称"},{default:o(()=>[l(d,{modelValue:u.petName,"onUpdate:modelValue":e[1]||(e[1]=t=>u.petName=t),placeholder:"请输入宠物名称",clearable:""},null,8,["modelValue"])]),_:1}),l(i,{label:"日志类型"},{default:o(()=>[l(b,{modelValue:u.careType,"onUpdate:modelValue":e[2]||(e[2]=t=>u.careType=t),placeholder:"全部类型",clearable:""},{default:o(()=>[l(n,{label:"喂食",value:1}),l(n,{label:"遛弯",value:2}),l(n,{label:"清洁",value:3}),l(n,{label:"体检",value:4}),l(n,{label:"其他",value:5}),l(n,{label:"入住登记",value:6})]),_:1},8,["modelValue"])]),_:1}),l(i,null,{default:o(()=>[l(p,{type:"primary",onClick:R},{default:o(()=>[l(_,null,{default:o(()=>[l(z)]),_:1}),e[12]||(e[12]=g("搜索 ",-1))]),_:1}),l(p,{onClick:le},{default:o(()=>[l(_,null,{default:o(()=>[l(ue)]),_:1}),e[13]||(e[13]=g("重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(j,{shadow:"never"},{default:o(()=>[L("div",Ie,[l(p,{type:"primary",onClick:ae},{default:o(()=>[l(_,null,{default:o(()=>[l(O)]),_:1}),e[14]||(e[14]=g("添加照料记录 ",-1))]),_:1})]),he((y(),D(ce,{data:P.value,stripe:"",border:""},{default:o(()=>[l(c,{prop:"id",label:"ID",width:"80"}),l(c,{prop:"orderNo",label:"订单号",width:"180"}),l(c,{prop:"roomNo",label:"房间号",width:"120"}),l(c,{prop:"petName",label:"宠物",width:"120"}),l(c,{prop:"careType",label:"类型",width:"100"},{default:o(({row:t})=>[l(pe,{type:X(t.careType)},{default:o(()=>[g(Te(Q(t.careType)),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"content",label:"照料内容","min-width":"200","show-overflow-tooltip":""}),l(c,{prop:"images",label:"图片",width:"100"},{default:o(({row:t})=>[t.images?(y(),D(p,{key:0,type:"primary",link:"",onClick:I=>oe(t)},{default:o(()=>[...e[15]||(e[15]=[g(" 查看图片 ",-1)])]),_:1},8,["onClick"])):(y(),U("span",xe,"-"))]),_:1}),l(c,{prop:"staffName",label:"记录人",width:"100"}),l(c,{prop:"createdAt",label:"记录时间",width:"180"}),l(c,{label:"操作",width:"120",fixed:"right"},{default:o(({row:t})=>[l(p,{type:"primary",link:"",onClick:I=>te(t)},{default:o(()=>[...e[16]||(e[16]=[g("编辑",-1)])]),_:1},8,["onClick"]),l(p,{type:"danger",link:"",onClick:I=>se(t)},{default:o(()=>[...e[17]||(e[17]=[g("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ve,A.value]]),l(me,{class:"pagination","current-page":f.page,"onUpdate:currentPage":e[3]||(e[3]=t=>f.page=t),"page-size":f.size,"onUpdate:pageSize":e[4]||(e[4]=t=>f.size=t),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:k,onCurrentChange:k},null,8,["current-page","page-size","total"])]),_:1}),l(q,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=t=>w.value=t),title:J.value,width:"600px"},{footer:o(()=>[l(p,{onClick:e[9]||(e[9]=t=>w.value=!1)},{default:o(()=>[...e[19]||(e[19]=[g("取消",-1)])]),_:1}),l(p,{type:"primary",onClick:ie,loading:E.value},{default:o(()=>[...e[20]||(e[20]=[g("确定",-1)])]),_:1},8,["loading"])]),default:o(()=>[l(F,{ref_key:"formRef",ref:x,model:r,rules:W,"label-width":"100px"},{default:o(()=>[l(i,{label:"订单",prop:"orderId"},{default:o(()=>[l(b,{modelValue:r.orderId,"onUpdate:modelValue":e[5]||(e[5]=t=>r.orderId=t),placeholder:"请选择订单",style:{width:"100%"},filterable:"",remote:"","remote-method":Z,loading:C.value,onVisibleChange:ee},{default:o(()=>[(y(!0),U(Y,null,G(h.value,t=>(y(),D(n,{key:t.id,label:`${t.orderNo}${t.roomNo?" - 房间:"+t.roomNo:""}${t.petNames?" - 宠物:"+t.petNames:""}`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),l(i,{label:"日志类型",prop:"careType"},{default:o(()=>[l(b,{modelValue:r.careType,"onUpdate:modelValue":e[6]||(e[6]=t=>r.careType=t),placeholder:"请选择类型",style:{width:"100%"}},{default:o(()=>[l(n,{label:"喂食",value:1}),l(n,{label:"遛弯",value:2}),l(n,{label:"清洁",value:3}),l(n,{label:"体检",value:4}),l(n,{label:"其他",value:5}),l(n,{label:"入住登记",value:6})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"照料内容",prop:"content"},{default:o(()=>[l(d,{modelValue:r.content,"onUpdate:modelValue":e[7]||(e[7]=t=>r.content=t),type:"textarea",placeholder:"请输入照料内容",rows:4},null,8,["modelValue"])]),_:1}),l(i,{label:"图片"},{default:o(()=>[l(fe,{"file-list":T.value,"onUpdate:fileList":e[8]||(e[8]=t=>T.value=t),action:"#","http-request":ne,"before-upload":re,"list-type":"picture-card",limit:10,accept:"image/*"},{default:o(()=>[l(_,null,{default:o(()=>[l(O)]),_:1})]),_:1},8,["file-list"]),e[18]||(e[18]=L("div",{style:{color:"#999","font-size":"12px","margin-top":"8px"}}," 最多上传10张图片，支持jpg/png格式，单张不超过10MB ",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(q,{modelValue:B.value,"onUpdate:modelValue":e[11]||(e[11]=t=>B.value=t),title:"图片预览",width:"600px"},{default:o(()=>[L("div",ze,[(y(!0),U(Y,null,G(S.value,(t,I)=>(y(),D(ge,{key:I,src:t,"preview-src-list":S.value,"initial-index":I,fit:"cover",style:{width:"150px",height:"150px",margin:"5px"}},null,8,["src","preview-src-list","initial-index"]))),128))])]),_:1},8,["modelValue"])])}}}),Me=ke(Ue,[["__scopeId","data-v-2e9416cb"]]);export{Me as default};
