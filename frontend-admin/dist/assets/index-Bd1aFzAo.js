import{v as L,r as d,j,U as q,B as _,C as v,D as u,ak as f,E as n,y as w,P as V,a4 as D,O as p,M as k,K as E,ag as F,u as Y,n as Q,z as l,G as M}from"./vue-Oyw5Wt-7.js";import{E as X,r as Z}from"./elementPlus-BZK7s8Hm.js";import{u as ee,r as te}from"./index-BHoJcF0t.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const oe={class:"support-container"},ne={class:"card-header"},ae={class:"user-list"},le={key:1,class:"user-items"},re=["onClick"],ce={class:"user-info"},ue={class:"name"},ie={class:"meta"},de={class:"chat-window"},ve={key:0,class:"empty-chat"},me={key:1,class:"chat-active"},_e={class:"chat-header"},fe={key:0,class:"no-messages"},he={class:"message-content"},ge={class:"text"},Ie={class:"time"},pe={class:"chat-input"},ke=L({__name:"index",setup(Se){const W=ee(),h=d([]),m=d(null),U=d(""),x=d([]),S=d(""),r=d(null),g=d(!1),N=d(null),$=d(null),A=d(null),T=e=>{const t=new Date(e),s=`${t.getHours()}`.padStart(2,"0"),a=`${t.getMinutes()}`.padStart(2,"0");return`${s}:${a}`},O=async()=>{await Q(),N.value&&(N.value.scrollTop=N.value.scrollHeight)},y=(e,t,s)=>{x.value.push({from:e,text:t,ts:s??Date.now()}),O()},R=e=>{if((e==null?void 0:e.type)==="USER_ASSIGNED"){e.roomId&&($.value=e.roomId),e.hotelId&&(A.value=e.hotelId);const s=h.value.find(a=>a.userId===m.value);s&&(s.online=!0);return}if((e==null?void 0:e.type)==="HISTORY"){(Array.isArray(e.messages)?e.messages:[]).forEach(a=>{if(!a)return;const I=a.sender==="staff"?"me":"user",c=a.text||a.message;if(c){const i=a.ts?Number(a.ts):void 0;y(I,String(c),i)}});return}const t=(e==null?void 0:e.text)||(e==null?void 0:e.message);t&&y("user",String(t))},H=e=>{const t=W.staffId||W.userId,s=localStorage.getItem("token")||"",I=`${window.location.origin.replace(/^http/,"ws")}/api/ws/chat?role=staff&staffId=${t}&userId=${e}${s?`&token=${encodeURIComponent(s)}`:""}`;console.log("Admin正在连接 WebSocket:",I),console.log("StaffId:",t,"UserId:",e),r.value=new WebSocket(I),r.value.onopen=()=>{console.log("Admin WebSocket 连接成功"),g.value=!0},r.value.onmessage=c=>{console.log("Admin收到消息:",c.data);try{const i=JSON.parse(c.data);R(i)}catch{y("user",String(c.data))}},r.value.onclose=c=>{console.log("Admin WebSocket 关闭:",c.code,c.reason),g.value=!1;const i=h.value.find(C=>C.userId===m.value);i&&(i.online=!1)},r.value.onerror=c=>{console.error("Admin WebSocket 错误:",c),g.value=!1}},K=e=>{m.value!==e.userId&&(r.value&&(r.value.close(),r.value=null),m.value=e.userId,U.value=e.userName||"用户"+e.userId,$.value=e.roomId||null,A.value=e.hotelId||null,x.value=[],g.value=!1,e.unread=0,H(e.userId))},z=()=>{const e=S.value.trim();!e||!r.value||r.value.readyState!==WebSocket.OPEN||(r.value.send(JSON.stringify({text:e})),y("me",e),S.value="")},B=async()=>{try{console.log("刷新等待用户列表...");const e=await te.get("/support/waiting-users");if(console.log("等待用户列表响应:",e),e.data){const t=e.data.map(s=>({userId:s.userId,userName:s.userName,roomId:s.roomId,hotelId:s.hotelId,unread:s.unread||0,online:!0}));m.value&&!t.some(s=>s.userId===m.value)&&t.push({userId:m.value,userName:U.value,roomId:$.value||void 0,hotelId:A.value||void 0,unread:0,online:!1}),h.value=t,console.log("已加载用户:",h.value)}}catch(e){console.error("获取等待用户列表失败:",e),X.error(e.message||"获取等待用户列表失败")}};return j(()=>{B();const e=setInterval(B,1e4);q(()=>{clearInterval(e),r.value&&r.value.close()})}),(e,t)=>{const s=f("el-button"),a=f("el-badge"),I=f("el-empty"),c=f("el-avatar"),i=f("el-tag"),C=f("el-col"),P=f("el-input"),G=f("el-row"),J=f("el-card");return l(),_("div",oe,[v(J,{class:"box-card"},{header:u(()=>[n("div",ne,[t[1]||(t[1]=n("span",null,"在线客服",-1)),v(a,{value:h.value.length,hidden:h.value.length===0},{default:u(()=>[v(s,{onClick:B,icon:Y(Z),circle:"",size:"small"},null,8,["icon"])]),_:1},8,["value","hidden"])])]),default:u(()=>[v(G,{gutter:20},{default:u(()=>[v(C,{span:8},{default:u(()=>[n("div",ae,[t[3]||(t[3]=n("h3",null,"等待咨询的用户",-1)),h.value.length===0?(l(),w(I,{key:0,description:"暂无用户等待"})):(l(),_("div",le,[(l(!0),_(V,null,D(h.value,o=>(l(),_("div",{key:o.userId,class:M(["user-item",{active:m.value===o.userId}]),onClick:b=>K(o)},[v(c,{size:40},{default:u(()=>{var b;return[k(p(((b=o.userName)==null?void 0:b[0])||"U"),1)]}),_:2},1024),n("div",ce,[n("div",ue,p(o.userName||"用户"+o.userId),1),n("div",ie,[k(" 房间ID: "+p(o.roomId||"未知")+" ",1),o.online===!1?(l(),w(i,{key:0,size:"small",type:"info",class:"ml-2"},{default:u(()=>[...t[2]||(t[2]=[k("离线",-1)])]),_:1})):E("",!0)])]),o.unread>0?(l(),w(a,{key:0,value:o.unread},null,8,["value"])):E("",!0)],10,re))),128))]))])]),_:1}),v(C,{span:16},{default:u(()=>[n("div",de,[m.value?(l(),_("div",me,[n("div",_e,[n("span",null,"正在与 "+p(U.value)+" 聊天",1),g.value?(l(),w(i,{key:0,type:"success",size:"small"},{default:u(()=>[...t[4]||(t[4]=[k("已连接",-1)])]),_:1})):(l(),w(i,{key:1,type:"info",size:"small"},{default:u(()=>[...t[5]||(t[5]=[k("连接中...",-1)])]),_:1}))]),n("div",{class:"chat-messages",ref_key:"chatBody",ref:N},[x.value.length===0?(l(),_("div",fe,"暂无消息")):E("",!0),(l(!0),_(V,null,D(x.value,(o,b)=>(l(),_("div",{key:b,class:M(["message",o.from==="me"?"message-sent":"message-received"])},[n("div",he,[n("div",ge,p(o.text),1),n("div",Ie,p(T(o.ts)),1)])],2))),128))],512),n("div",pe,[v(P,{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=o=>S.value=o),onKeyup:F(z,["enter"]),placeholder:"输入消息...",disabled:!g.value},null,8,["modelValue","disabled"]),v(s,{type:"primary",onClick:z,disabled:!g.value||!S.value.trim()},{default:u(()=>[...t[6]||(t[6]=[k(" 发送 ",-1)])]),_:1},8,["disabled"])])])):(l(),_("div",ve,[v(I,{description:"请从左侧选择用户开始聊天"})]))])]),_:1})]),_:1})]),_:1})])}}}),ye=se(ke,[["__scopeId","data-v-aa02624c"]]);export{ye as default};
